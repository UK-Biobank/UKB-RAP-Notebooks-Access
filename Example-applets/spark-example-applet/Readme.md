<!-- dx-header -->
# spark-example-applet (DNAnexus/UKB-RAP Platform App)

This is the source code for an app that runs on the UK Biobank Research Analysis Platform (UKB-RAP).
For more information about how to run or modify it, see
https://documentation.dnanexus.com/.
<!-- /dx-header -->

<!-- Insert a description of your app here -->

<!--
TODO: This app directory was automatically generated by dx-app-wizard;
please edit this Readme.md file to include essential documentation about
your app that would be helpful to users. (Also see the
Readme.developer.md.) Once you're done, you can remove these TODO
comments.

For more info, see https://documentation.dnanexus.com/developer.
--> 
Documentation on building applets can be found in the DNAnexus documentation at https://documentation.dnanexus.com/developer/apps/intro-to-building-apps. Specific references are linked throughout this readme.

This applet provides a simple example of building an applet that interacts with the spark dataset. It takes a field name as input and returns the mean of that field. Spark enabled applets [must be built in bash](https://documentation.dnanexus.com/developer/apps/developing-spark-apps#bash-apps). Pyspark scripts are included in the resources folder and submitted in the bash script. 

The skeleton structure of an applet can be created with [dx-app-wizard](https://documentation.dnanexus.com/developer/apps/intro-to-building-apps), which is provided in the [dx-toolkit](https://documentation.dnanexus.com/downloads#dnanexus-platform-sdk). 

# Applet components

An applet is made up three main components in a [specific directory structure](https://documentation.dnanexus.com/developer/apps/app-build-process#app-directory-structure):
- [`dxapp.json` file](https://documentation.dnanexus.com/developer/apps/app-build-process#the-dxapp.json-app-metadata-file) - json containing specifications for inputs, outputs and the applet run environment.
- `src/` folder - contains source code for applet
- [`resources/` folder](https://documentation.dnanexus.com/developer/apps/app-build-process#the-resources-subdirectory) - contains files or executables necessary for your applet. [This folder will be unpacked in the root directory of the container the applet runs in.](https://documentation.dnanexus.com/developer/apps/app-build-process#the-resources-directory-and-its-use)

## dx-app.json

The dx-app.json file provides the specifications for how the applet will be run. This is created with dx-app-wizard, but can be edited at any time.

### inputSpec - Input Specification

Inputs are specified with variable names and input types.

```json
"inputSpec": [
    {
      "name": "field_name",
      "class": "string",
      "optional": false,
      "help": ""
    }
  ]
```

### outputSpec - Output Specification

Similarly, outputs are specified with variable names and output types.

```json
"outputSpec": [
    {
      "name": "mean",
      "class": "string",
      "help": ""
    }
  ],
```

### runSpec - Run Specification

Python package dependencies can be specified in the execDepends section.

```json
"execDepends": [
      {"name" : "pyspark",
      "package_manager": "pip"},
      {"name" : "pandas",
       "package_manager": "pip"}
    ]
```
    
To use Spark, a [cluster specification](https://documentation.dnanexus.com/developer/apps/developing-spark-apps#cluster-specifications) must be supplied.

```json
"clusterSpec": {
            "type": "dxspark",
            "version": "3.2.3",
            "initialInstanceCount": 1
          }
```

## src/ folder

The `spark-example-applet.sh` file contains the code for the applet. This script generates the SQL used to extract the data for the field provided as input using [dx-toolkit command line utilities](https://documentation.dnanexus.com/user/helpstrings-of-sdk-command-line-utilities). The `pyspark-app.py` script is then submitted to the Spark cluster using `dx spark-submit /pyspark-app.py` with the generated SQL as an argument. Note that the `pyspark-app.py` file is called from the root directory, where it is unpacked from the `resources/` directory in the applet build process. The working directory of the applet is `/home/dnanexus`.

## resources/ folder

The `pyspark-app.py` script to extract the mean has been included in the resources folder, which is unpacked to the root directory of the container the applet runs in. 

# Building and running the applet

The applet is built and run in the command line with the [dx-toolkit](https://documentation.dnanexus.com/downloads#dnanexus-platform-sdk). You can find [more information on the dx-toolkit command line utilities](https://documentation.dnanexus.com/user/helpstrings-of-sdk-command-line-utilities) and options available in the documentation. 

- Clone this repo.
- Login to the DNAnexus platform with `dx login` and select the UKB-RAP project you want to work in with `dx select`.
- From the spark-example-applet folder, enter `dx build .`
- Run the applet on the UKB-RAP with the command `dx run spark-example-applet -i field_name=<rap_field_name>`. -i is used to give inputs to the applet. `<rap_field_name>` should be replaced with the field of interest, using UKB-RAP field name nomenclature, e.g. p23474_i0. The approximate cost to run this example applet is less than Â£0.01.
